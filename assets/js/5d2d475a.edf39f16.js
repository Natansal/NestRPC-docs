"use strict";(self.webpackChunknestjs_rpc_docs=self.webpackChunknestjs_rpc_docs||[]).push([[375],{6713:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"query/advanced","title":"Advanced Features","description":"Advanced React Query features. Additional query keys, manual invalidation, custom query clients, and more.","source":"@site/docs/query/advanced.md","sourceDirName":"query","slug":"/query/advanced","permalink":"/NestRPC-docs/docs/query/advanced","draft":false,"unlisted":false,"editUrl":"https://github.com/Natansal/NestRPC-docs/blob/main/docs/query/advanced.md","tags":[],"version":"current","frontMatter":{"title":"Advanced Features","description":"Advanced React Query features. Additional query keys, manual invalidation, custom query clients, and more."},"sidebar":"tutorialSidebar","previous":{"title":"Mutation Hooks","permalink":"/NestRPC-docs/docs/query/mutations"},"next":{"title":"FAQ","permalink":"/NestRPC-docs/docs/faq"}}');var i=r(4848),t=r(8453);const a={title:"Advanced Features",description:"Advanced React Query features. Additional query keys, manual invalidation, custom query clients, and more."},l="Advanced Features",c={},d=[{value:"\ud83d\udd11 Additional Query Keys",id:"-additional-query-keys",level:2},{value:"Using Arrays",id:"using-arrays",level:3},{value:"Using Functions",id:"using-functions",level:3},{value:"In Factory Defaults",id:"in-factory-defaults",level:3},{value:"\ud83d\udd04 Manual Cache Invalidation",id:"-manual-cache-invalidation",level:2},{value:"With Filters",id:"with-filters",level:3},{value:"\ud83d\udce4 File Uploads",id:"-file-uploads",level:2},{value:"Single File Upload",id:"single-file-upload",level:3},{value:"Multiple File Upload",id:"multiple-file-upload",level:3},{value:"With Static RPC Options",id:"with-static-rpc-options",level:3},{value:"Dynamic Options Override",id:"dynamic-options-override",level:3},{value:"\ud83c\udfaf Custom Query Client",id:"-custom-query-client",level:2},{value:"\ud83d\udd04 Optimistic Updates",id:"-optimistic-updates",level:2},{value:"\ud83c\udfa8 Error Handling",id:"-error-handling",level:2},{value:"\ud83d\udd10 Authentication Patterns",id:"-authentication-patterns",level:2},{value:"\ud83d\udcca Query Key Structure",id:"-query-key-structure",level:2},{value:"Example Query Keys",id:"example-query-keys",level:3},{value:"\ud83c\udfaf Best Practices",id:"-best-practices",level:2},{value:"\ud83d\udcda Related",id:"-related",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"advanced-features",children:"Advanced Features"})}),"\n",(0,i.jsxs)(n.p,{children:["This guide covers advanced features and patterns for using ",(0,i.jsx)(n.code,{children:"@nestjs-rpc/query"})," in production applications."]}),"\n",(0,i.jsx)(n.h2,{id:"-additional-query-keys",children:"\ud83d\udd11 Additional Query Keys"}),"\n",(0,i.jsx)(n.p,{children:"Extend query keys for more granular cache control. Useful when you need to differentiate queries with the same body but different contexts."}),"\n",(0,i.jsx)(n.h3,{id:"using-arrays",children:"Using Arrays"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const { data } = useRpcQuery(\n  rpc.user.queries.getUserById,\n  { id: "123" },\n  {\n    useAdditionalQueryKey: ["admin-view"], // Adds to query key\n  },\n);\n'})}),"\n",(0,i.jsx)(n.h3,{id:"using-functions",children:"Using Functions"}),"\n",(0,i.jsx)(n.p,{children:"Functions allow you to use hooks inside, enabling dynamic query keys:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const { data } = useRpcQuery(\n  rpc.user.queries.getUserById,\n  { id: "123" },\n  {\n    useAdditionalQueryKey: () => {\n      const { userRole } = useAuth(); // Can use hooks!\n      return [userRole];\n    },\n  },\n);\n'})}),"\n",(0,i.jsx)(n.h3,{id:"in-factory-defaults",children:"In Factory Defaults"}),"\n",(0,i.jsx)(n.p,{children:"Set additional keys in factory defaults:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const useUserById = createRpcQuery(rpc.user.queries.getUserById, {\n  useAdditionalQueryKey: ["default"],\n});\n\n// Instance-level keys are merged with factory defaults\nconst { data } = useUserById(\n  { id: "123" },\n  {\n    useAdditionalQueryKey: ["instance"], // Final key: [\'default\', \'instance\']\n  },\n);\n'})}),"\n",(0,i.jsx)(n.h2,{id:"-manual-cache-invalidation",children:"\ud83d\udd04 Manual Cache Invalidation"}),"\n",(0,i.jsxs)(n.p,{children:["Use ",(0,i.jsx)(n.code,{children:"useInvalidateRpcQuery"})," for manual cache invalidation:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { useInvalidateRpcQuery } from '@nestjs-rpc/query';\nimport { rpc } from './rpc-client';\n\nfunction UserActions() {\n  const invalidate = useInvalidateRpcQuery();\n\n  const handleRefresh = () => {\n    invalidate(rpc.user.queries.listUsers);\n  };\n\n  const handleRefreshAll = () => {\n    // Invalidate all user queries\n    invalidate(rpc.user.queries.listUsers, {\n      exact: false, // Invalidate all queries starting with this path\n    });\n  };\n\n  return (\n    <div>\n      <button onClick={handleRefresh}>Refresh Users</button>\n      <button onClick={handleRefreshAll}>Refresh All User Queries</button>\n    </div>\n  );\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"with-filters",children:"With Filters"}),"\n",(0,i.jsx)(n.p,{children:"Apply filters for more precise invalidation:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const invalidate = useInvalidateRpcQuery();\n\n// Invalidate only active queries\ninvalidate(rpc.user.queries.listUsers, {\n  active: true,\n});\n\n// Invalidate with predicate\ninvalidate(rpc.user.queries.getUserById, {\n  predicate: (query) => {\n    const [, body] = query.queryKey;\n    return body.id === 'specific-id';\n  },\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-file-uploads",children:"\ud83d\udce4 File Uploads"}),"\n",(0,i.jsx)(n.h3,{id:"single-file-upload",children:"Single File Upload"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const mutation = useRpcMutation(rpc.files.uploadFile, {\n  onSuccess: () => console.log("Uploaded!"),\n});\n\nconst handleUpload = (file: File) => {\n  mutation.mutate({\n    body: { description: "My file" },\n    file: file,\n  });\n};\n'})}),"\n",(0,i.jsx)(n.h3,{id:"multiple-file-upload",children:"Multiple File Upload"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const mutation = useRpcMutation(rpc.files.uploadFiles, {\n  invalidate: [rpc.files.listFiles],\n});\n\nconst handleUpload = (files: File[]) => {\n  mutation.mutate({\n    body: { category: "documents" },\n    files: files,\n  });\n};\n'})}),"\n",(0,i.jsx)(n.h3,{id:"with-static-rpc-options",children:"With Static RPC Options"}),"\n",(0,i.jsx)(n.p,{children:"Set default RPC options for file uploads:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const useUploadFile = createRpcMutation(rpc.files.uploadFile, {\n  invalidate: [rpc.files.listFiles],\n  rpcOptions: {\n    requestOptions: { timeout: 30000 }, // 30 second timeout\n  },\n});\n\n// Use with file\nconst uploadFile = useUploadFile();\nuploadFile.mutate({\n  body: { description: "My file" },\n  file: fileInput.files[0],\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"dynamic-options-override",children:"Dynamic Options Override"}),"\n",(0,i.jsx)(n.p,{children:"Override static options per call:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:'const useUploadFile = createRpcMutation(rpc.files.uploadFile, {\n  rpcOptions: {\n    requestOptions: { timeout: 30000 },\n  },\n});\n\nconst uploadFile = useUploadFile();\nuploadFile.mutate({\n  body: { description: "My file" },\n  file: fileInput.files[0],\n  rpcOptions: {\n    requestOptions: { timeout: 60000 }, // Overrides the 30000 from hook\n  },\n});\n'})}),"\n",(0,i.jsx)(n.h2,{id:"-custom-query-client",children:"\ud83c\udfaf Custom Query Client"}),"\n",(0,i.jsxs)(n.p,{children:["Pass a custom ",(0,i.jsx)(n.code,{children:"QueryClient"})," instance for isolated query management:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"import { QueryClient } from '@tanstack/react-query';\n\nconst customQueryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      staleTime: 60000,\n    },\n  },\n});\n\nconst { data } = useRpcQuery(\n  rpc.user.queries.listUsers,\n  undefined,\n  {},\n  customQueryClient, // Use specific client\n);\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-optimistic-updates",children:"\ud83d\udd04 Optimistic Updates"}),"\n",(0,i.jsx)(n.p,{children:"Implement optimistic updates for better UX:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"const useUpdateUser = createRpcMutation(rpc.user.mutations.updateUser, {\n  invalidate: [rpc.user.queries.listUsers],\n  onMutate: async (newData) => {\n    // Cancel outgoing refetches\n    await queryClient.cancelQueries({ queryKey: [rpc.user.queries.listUsers] });\n\n    // Snapshot previous value\n    const previousUsers = queryClient.getQueryData([rpc.user.queries.listUsers]);\n\n    // Optimistically update\n    queryClient.setQueryData([rpc.user.queries.listUsers], (old: any) => {\n      return old?.map((user: any) =>\n        user.id === newData.body.id ? { ...user, ...newData.body } : user\n      );\n    });\n\n    return { previousUsers };\n  },\n  onError: (err, newData, context) => {\n    // Rollback on error\n    queryClient.setQueryData([rpc.user.queries.listUsers], context?.previousUsers);\n  },\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-error-handling",children:"\ud83c\udfa8 Error Handling"}),"\n",(0,i.jsx)(n.p,{children:"Handle errors at multiple levels:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Global error handling\nconst queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      onError: (error) => {\n        // Global error handler\n        console.error('Query error:', error);\n      },\n    },\n    mutations: {\n      onError: (error) => {\n        // Global mutation error handler\n        console.error('Mutation error:', error);\n      },\n    },\n  },\n});\n\n// Hook-level error handling\nconst mutation = useRpcMutation(rpc.user.mutations.createUser, {\n  onError: (error) => {\n    if (error.response?.status === 409) {\n      toast.error('User already exists');\n    } else {\n      toast.error('Failed to create user');\n    }\n  },\n});\n\n// Component-level error handling\nconst { error } = useRpcQuery(rpc.user.queries.getUser, { id: userId });\nif (error) {\n  return <ErrorBoundary error={error} />;\n}\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-authentication-patterns",children:"\ud83d\udd10 Authentication Patterns"}),"\n",(0,i.jsx)(n.p,{children:"Handle authentication with RPC options:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Create mutation with auth headers\nconst useCreateUser = createRpcMutation(rpc.user.mutations.createUser, {\n  invalidate: [rpc.user.queries.listUsers],\n  rpcOptions: {\n    requestOptions: {\n      headers: {\n        get Authorization() {\n          return `Bearer ${getAuthToken()}`;\n        },\n      },\n    },\n  },\n});\n\n// Or update dynamically\nconst createUser = useCreateUser();\ncreateUser.mutate({\n  body: { name: 'John' },\n  rpcOptions: {\n    requestOptions: {\n      headers: {\n        Authorization: `Bearer ${newToken}`,\n      },\n    },\n  },\n});\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-query-key-structure",children:"\ud83d\udcca Query Key Structure"}),"\n",(0,i.jsx)(n.p,{children:"Query keys are automatically generated as:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"[...path, body, rpcOptions, ...additionalKeys];\n"})}),"\n",(0,i.jsx)(n.p,{children:"This ensures proper cache differentiation based on all parameters."}),"\n",(0,i.jsx)(n.h3,{id:"example-query-keys",children:"Example Query Keys"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-typescript",children:"// Simple query\nuseRpcQuery(rpc.user.queries.listUsers, undefined);\n// Key: ['user', 'queries', 'listUsers', undefined, {}, []]\n\n// With body\nuseRpcQuery(rpc.user.queries.getUser, { id: '123' });\n// Key: ['user', 'queries', 'getUser', { id: '123' }, {}, []]\n\n// With additional keys\nuseRpcQuery(rpc.user.queries.getUser, { id: '123' }, {\n  useAdditionalQueryKey: ['admin'],\n});\n// Key: ['user', 'queries', 'getUser', { id: '123' }, {}, ['admin']]\n"})}),"\n",(0,i.jsx)(n.h2,{id:"-best-practices",children:"\ud83c\udfaf Best Practices"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Use additional query keys sparingly"})," - Only when you need context-specific caching"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Manual invalidation"})," - Use when automatic invalidation isn't sufficient"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Optimistic updates"})," - Improve perceived performance for mutations"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Error boundaries"})," - Handle errors gracefully at multiple levels"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Custom query clients"})," - Use for isolated query management when needed"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"-related",children:"\ud83d\udcda Related"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/query/queries",children:"Query Hooks"})," - Basic query usage"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/docs/query/mutations",children:"Mutation Hooks"})," - Basic mutation usage"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://tanstack.com/query/latest",children:"React Query Docs"})," - Complete React Query documentation"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>l});var s=r(6540);const i={},t=s.createContext(i);function a(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(t.Provider,{value:n},e.children)}}}]);